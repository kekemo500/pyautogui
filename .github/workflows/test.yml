name: Test OrganicHits on Ubuntu

on:
  workflow_dispatch:

jobs:
  test-organichits:
    runs-on: ubuntu-latest

    steps:
    - name: Update APT
      run: sudo apt-get update

    - name: Install dependencies
      run: sudo apt-get install -y wget dpkg zip

    - name: Download & Install OrganicHits
      run: |
        wget -qO organichits.deb https://cdn.organichits.co/download/organichits-exchanger_2.2.4_amd64.deb
        sudo dpkg -i organichits.deb || true
        sudo apt-get install -f -y
        rm organichits.deb

    - name: List installed files and save list
      run: |
        dpkg -L organichits-exchanger > installed_files.txt

    - name: Copy OrganicHits files into a folder
      run: |
        mkdir organic_dump

        # Read each line from installed_files.txt and copy only existing files
        while read file; do
          if [ -f "$file" ]; then
            mkdir -p "organic_dump/$(dirname "$file")"
            cp "$file" "organic_dump/$file"
          fi
        done < installed_files.txt

    - name: Create ZIP archive
      run: |
        zip -r organic_files.zip organic_dump

    - name: Upload ZIP as artifact
      uses: actions/upload-artifact@v3
      with:
        name: organichits-files
        path: organic_files.zip
